const express=require("express"),bodyParser=require("body-parser"),cors=require("cors"),fs=require("fs"),path=require("path"),sharp=require("sharp"),multer=require("multer"),requestIp=require("request-ip"),uuid=require("uuid"),bcrypt=require("bcryptjs"),geoip=require("fast-geoip");var macaddress=require("macaddress");const sanitizeHtml=require("sanitize-html"),moment=require("moment"),schedule=require("node-schedule"),{Server:e}=require("socket.io"),http=require("http"),app=express(),upload=multer();app.use(cors());const server=http.createServer(app),io=new e(server,{cors:{origin:"*",methods:["GET","PUT","POST","HEAD","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization","Origin","Access-Control-Allow-Origin","Access-control-request-private-network"]}});require("./database");const voxModel=require("./schemas/voxSchema"),userModel=require("./schemas/userSchema"),commentModel=require("./schemas/commentSchema"),reportModel=require("./schemas/reportSchema"),blacklistModel=require("./schemas/blacklistSchema");app.set("port",process.env.PORT||3001);const corsOptions=app.use(bodyParser.urlencoded({extended:!1}));function anonRandom(){var e=Math.floor(85*Math.random());switch(!0){case e<20:return"red";case e<40&&e>=20:return"blue";case e<60&&e>=40:return"green";case e<80&&e>=60:return"yellow";case e<84&&e>=80:return"multi";case 84===e:return"black"}}function opComment(e,a){return e==a}app.use(bodyParser.json()),app.use(requestIp.mw()),moment.locale("es"),server.listen(app.get("port"),()=>{console.log("Puerto: ",app.get("port")),console.log("Node version is: "+process.version)});const job=schedule.scheduleJob("20 * * * *",function(){voxToDelete=voxModel.find({isArchived:!0}).then(e=>{e.map(function(e){e&&!1===e.isUrl&&(fs.unlinkSync(path.resolve("./backgrounds/"+e.filename+"."+e.fileExtension)),fs.unlinkSync(path.resolve("./backgrounds/low-res_"+e.filename+".jpeg"))),voxModel.findOneAndDelete({filename:e.filename}).then(e=>{}),commentModel.find({voxId:e.filename}).then(a=>{a.map(function(a){e&&e.fileExtension&&fs.unlinkSync(path.resolve("./backgrounds/"+e.filename+"."+e.fileExtension)),commentModel.findOneAndDelete({filename:e.filename}).then(e=>{})})})}),commentModel.find({isArchived:!0}).then(e=>{e.map(function(e){e&&e.fileExtension&&fs.unlinkSync(path.resolve("./backgrounds/"+e.filename+"."+e.fileExtension)),commentModel.findOneAndDelete({filename:e.filename}).then(e=>{})})})})});function categoryDecoder(e){switch(!0){case"ANM"==e:return[1,"Anime"];case"ARTE"==e:return[2,"Arte"];case"AUTO"===e:return[3,"Autos"];case"BANT"===e:return[4,"International Random"];case"CON"===e:return[5,"Consejos"];case"CYTV"===e:return[6,"Cine y TV"];case"DEPO"===e:return[7,"Deportes"];case"DWNL"===e:return[8,"Descargas"];case"ECO"===e:return[9,"Economia"];case"FEM"===e:return[10,"Soy mujer"];case"FIT"===e:return[11,"Fitness"];case"GAS"===e:return[12,"Gastronomia"];case"GEN"===e:return[13,"General"];case"GMR"===e:return[14,"Gamer"];case"GORE"===e:return[15,"Gore"];case"GYM"===e:return[16,"Gimnasio"];case"HIST"===e:return[17,"Historias"];case"HIS"===e:return[18,"Historia"];case"INT"===e:return[19,"Internacional"];case"JIJO"===e:return[20,"Humor"];case"LGBT"===e:return[21,"LGBT"];case"NSFW"===e:return[22,"Pornografia"];case"BDSM"===e:return[23,"Fetiches"];case"OMNI"===e:return[24,"Omniverso"];case"PARA"===e:return[25,"Paranormal"];case"POL"===e:return[26,"Politica"];case"PREG"===e:return[27,"Preguntas"];case"PROG"===e:return[28,"Programacion"];case"SCI"===e:return[29,"Ciencia"];case"TECH"===e:return[30,"Tecnologia"];case"UFF"===e:return[31,"Random"];case"YTB"===e:return[32,"Youtube"];case"HLT"===e:return[33,"Salud"];case"MUS"===e:return[34,"Musica"];case"NOT"===e:return[35,"Noticias"];case"NRM"===e:return[36,"Normies"];case"LIT"===e:return[37,"Literatura"];case"LUG"===e:return[38,"Lugares"];case"HUM"===e:return[39,"Humanidades"];default:return[0,"Invalid"]}}function nl2br2(e){return e}function commentProcessing(e){return e=(e=(e=(e=(e=e.replaceAll(/</g,".")).replace(/(^>((?!>).)*$)/gm,"<span class='greentext'> $1 </span>")).replace(/((>>)\b\w{7}\b)/g,"<a> $1 </a>").replace(/#>>/g,"#")).replace(/((>>)(http|https):\/\/[\w?=&.\/-;#~%-]+(?![\w?&.\/;#~%"=-]*>))/g,"<a href='$1'> $1 </a>").replace(/href='>>/g,"href='").replace(/#http/g,"http")).replace(/(\r?\n)/g,"<br>")}function voxProcessing(e){return e=(e=(e=(e=e.replaceAll(/</g,".")).replace(/(^>((?!>).)*$)/gm,"<span class='greentext'> $1 </span>")).replace(/((>>)(http|https):\/\/[\w?=&.\/-;#~%-]+(?![\w?&.\/;#~%"=-]*>))/g,"<a href='$1'> $1 </a>").replace(/href='>>/g,"href='").replace(/#http/g,"http")).replace(/(\r?\n)/g,"<br>")}function urlProcess(e){if("video"==e.fileExtension){var a="https://img.youtube.com/vi/"+e.url+"/0.jpg";return a}var a="../backgrounds/low-res_"+e.filename+".jpeg";return a}app.post("/postVox",upload.any(),async(e,a)=>{errors=[];var o=await macaddress.one();let n=uuid.v4();if((!e.body.voxTitle||e.body.voxTitle.length>120)&&errors.push("Titulo invalido"),(!e.body.voxDescription||e.body.voxDescription.length>3e3)&&errors.push("Descripcion invalida"),(!e.body.voxCategory||e.body.voxCategory>39||e.body.voxCategory<1)&&errors.push("Categoria invalida"),e.body.username&&36==e.body.username.length){var r=await userModel.findOne({userId:e.body.username});r.voxDelay>Date.now()&&errors.push("Tenes que esperar "+Math.floor((r.voxDelay-Date.now())/6e4)+" minutos para crear otro vox"),e.files[0]&&e.files[0].size>4e6&&errors.push("Se admite un peso maximo de 4MB para subir archivos multimedia en voxes");var t=await blacklistModel.findOne({macaddres:o});if(t&&t.ip&&(t.dateEnd.getTime()>Date.now()?(errors.push("razon: "+t.description),errors.push(t.title),errors.push("Tu ban termina "+moment(t.dateEnd).endOf("day").fromNow())):await t.deleteOne()),errors.length>0){var s={errors:errors};a.send(s)}else{if(e.files[0]){var d=e.files[0].originalname.split(".").pop();if("jpg"==d|"png"==d|"gif"==d|"jpeg"==d){let i=path.join(__dirname,"../backgrounds/"+n+"."+d);fs.writeFileSync(i,e.files[0].buffer),sharp(i).resize(250,250).toFormat("jpeg").jpeg({quality:90}).toFile(path.join(__dirname,"../backgrounds/low-res_"+n+".jpeg"),function(e){})}}else if(""!=e.body.voxUrl){if(/(http(s?):)([/|.|\w|\s|-])*\.(?:jpg|gif|png|webp|jpeg)/g.test(e.body.voxUrl))var l=!0,d="image";else if(11==e.body.voxUrl.length)var l=!0,d="video";else errors.push("Error de formato")}else errors.push("Formato invalido");if(errors.length>0){var s={errors:errors};a.send(s)}else{var c=await geoip.lookup(e.clientIp),u="",p="";if(c&&c.country&&(u=c.country),c&&c.city&&(p=c.city),/(^>((?!>).)*$)/gm.test(e.body.voxDescription))var m=!0;else var m=!1;let y=await bcrypt.hash(e.clientIp,10);var $=[{ip:y,macaddres:o,location:u,city:p}];let v=new voxModel({title:e.body.voxTitle,description:voxProcessing(e.body.voxDescription),category:e.body.voxCategory,filename:n,metadata:$,fileExtension:d,isURL:l,url:e.body.voxUrl,dice:m,username:e.body.username});await userModel.findOneAndUpdate({userId:e.body.username},{voxDelay:new Date(Date.now()+6e5)},{new:!0}).catch(e=>{}),await v.save().then(e=>{a.send(e)})}}}else errors.push("Usuario invalido")}),app.post("/getVoxes",async(e,a)=>{hiddenCategories=[];var o="",n="";e.body.userData&&""!=e.body.userData.hiddenWords&&(n=(o=e.body.userData.hiddenWords).map(function(e){return RegExp(e,"i")})),e.body.userData&&(hiddenCategories=e.body.userData.hiddenCategories);var r=await voxModel.find({title:{$nin:n},category:{$nin:hiddenCategories},isArchived:{$nin:!0}}).limit(400).sort({lastUpdate:"desc"});a.send(r)}),app.get("/getVoxes/:id",async(e,a)=>{var o=await voxModel.find({category:e.params.id,isArchived:{$nin:!0}}).sort({lastUpdate:"desc"}),n=await voxModel.count({category:e.params.id}),r=400;n>r&&await (voxToDelete=await voxModel.find({category:e.params.id}).limit(n-r).sort({lastUpdate:"asc"})).map(function(e){!1===e.isUrl&&(fs.unlinkSync(path.resolve("./backgrounds/"+e.filename+"."+e.fileExtension)),fs.unlinkSync(path.resolve("./backgrounds/low-res_"+e.filename+".jpeg"))),voxModel.findOneAndDelete({filename:e.filename}),commentModel.find({voxId:e.filename}).then(a=>{a.map(function(a){e.fileExtension&&fs.unlinkSync(path.resolve("./backgrounds/"+e.filename+"."+e.fileExtension)),commentModel.findOneAndDelete({filename:e.filename})})})}),a.send(o)}),app.get("/searchVoxes/:title",async(e,a)=>{let o=e.params.title,n=RegExp(o,"i");var r=await voxModel.find({title:{$regex:n},isArchived:{$nin:!0}}).sort({lastUpdate:"desc"});a.send(r)}),app.get("/getVox/:id",async(e,a)=>{var o=await voxModel.find({filename:e.params.id,isArchived:{$nin:!0}});a.send(o)}),app.post("/postSession",async(e,a)=>{let o=uuid.v4(),n=uuid.v4(),r=await bcrypt.hash(n,10),t=new userModel({userId:o,userPassword:r});await t.save().then(e=>{a.send({userData:t,password:n})})}),app.post("/postHiddenWords",async(e,a)=>{if(e.body.word.length&&e.body.word.length>500)a.send({errors:["Solo podes agregar hasta 500 caracteres"]});else{var o=await userModel.findOneAndUpdate({userId:e.body.user.userData.userId},{hiddenWords:e.body.words}).catch(e=>{a.send("Ocurrio un error")});a.send(o)}}),app.post("/postHiddenCategories",async(e,a)=>{var o=[];if(e.body.word.length&&e.body.word.length>200)a.send({errors:["Solo podes agregar hasta 200 caracteres"]});else{e.body.words.forEach((e,a)=>{0!=categoryDecoder(e)[0]&&o.push(categoryDecoder(e)[0])});var n=await userModel.findOneAndUpdate({userId:e.body.user.userData.userId},{hiddenCategories:o}).catch(e=>{a.send("Ocurrio un error")});a.send(n)}}),app.post("/getSession",async(e,a)=>{var o=await userModel.findOne({userId:e.body.userName});if(o){let n=await bcrypt.compare(e.body.userPassword,o.userPassword).catch(e=>{a.send("Contrase\xf1a incorrecta")});n?a.send({userData:o,password:e.body.userPassword}):a.send("Contrase\xf1a incorrecta")}else a.send("Token invalido")}),app.post("/removeNotification",async(e,a)=>{var o=await userModel.updateMany({userId:e.body.userId},{$pull:{notifications:{voxId:e.body.voxid}}}).catch(e=>{});a.send("")}),app.post("/postComment",upload.any(),async(e,a)=>{var o=[],n=await geoip.lookup(e.clientIp),r=await macaddress.one();let t=uuid.v4();if((!e.body.commentText||e.body.commentText.length>5e3)&&o.push("Comentario invalido"),e.body.voxid&&36==e.body.voxid.length||o.push("Vox invalido"),e.body.username&&36==e.body.username.length){var s=await userModel.findOne({userId:e.body.username});s.commentDelay>Date.now()&&o.push("Tenes que esperar "+Math.floor((s.commentDelay-Date.now())/1e3)+" segundos para comentar")}else o.push("Usuario invalido");var d=await blacklistModel.findOne({macaddres:r});d&&d.ip&&(d.dateEnd.getTime()>Date.now()?(o.push("razon: "+d.description),o.push(d.title),o.push("Tu ban termina "+moment(d.dateEnd).endOf("day").fromNow())):await d.deleteOne()),e.files[0]&&e.files[0].size>2e6&&o.push("Se admite un peso maximo de 2MB para subir archivos multimedia");var i=anonRandom(),l=Math.floor(10*Math.random()),c=opComment(e.body.voxuser,e.body.username),u=uuid.v4().substring(0,7).toUpperCase();if(o.length>0){var p={errors:o};a.send(p)}else{var m=await voxModel.findOne({filename:e.body.voxid});if(e.body.commentText.match(/((>>)\b\w{7}\b)/g)){var y=e.body.commentText.match(/((>>)\b\w{7}\b)/g).filter((e,a,o)=>a===o.findIndex(a=>a.place===e.place&&a.name===e.name));y.forEach((a,o)=>{y[o]=a.replace(/>>/gm,"");var n='Respondieron tu comentario en el vox: "'+m.title.substring(0,30)+'"',r=e.body.commentText.substring(0,50),t=m.filename,s=urlProcess(m),d=commentModel.findOneAndUpdate({commentId:y[o]},{$push:{taggedBy:u}},{new:!0},(e,a)=>{}),i=commentModel.findOne({$and:[{commentId:y[o]},{voxId:e.body.voxid}]},(e,a)=>{if(e);else var o=userModel.findOneAndUpdate({userId:a.username},{$push:{notifications:{title:n,description:r,isAnnouncement:!1,voxId:t,date:Date.now(),url:s}}},{new:!0},(e,a)=>{})})})}var $=!0;if(e.files[0]){var v=e.files[0].originalname.split(".").pop();if("jpg"==v|"png"==v|"gif"==v|"jpeg"==v){let f=path.join(__dirname,"../backgrounds/comments/"+t+"."+v);fs.writeFileSync(f,e.files[0].buffer)}else o.push("Error de formato")}else if(""!=e.body.commentUrl){if(/(http(s?):)([/|.|\w|\s|-])*\.(?:jpg|gif|png|webp|jpeg)/g.test(e.body.commentUrl))var b=!0,v="image";else if(11==e.body.commentUrl.length)var b=!0,v="video";else o.push("Error de formato")}else $=!1;if(o.length>0){var p={errors:o};a.send(p)}else{let h=await bcrypt.hash(e.clientIp,10);var g=[{ip:h,macaddres:r,location:"geo.country",city:"geo.city"}];let w=new commentModel({commentText:commentProcessing(e.body.commentText),taggedTo:y,commentId:u,username:e.body.username,metadata:g,isURL:b,filename:t,hasMedia:$,voxId:e.body.voxid,anonColor:i,anonNumber:l,fileExtension:v,url:e.body.commentUrl,op:c});var x=userModel.findOneAndUpdate({userId:e.body.username},{commentDelay:new Date(Date.now()+1e4)},{new:!0},(e,a)=>{}),I=await voxModel.findOne({filename:e.body.voxid});I.commentCount>400?await I.updateOne({$inc:{commentsCount:1}}):await I.updateOne({$inc:{commentsCount:1},$set:{lastUpdate:Date.now()}});var M='Comentaron tu vox: "'+m.title.substring(0,30)+'"',_=e.body.commentText.substring(0,50),O=m.filename,D=urlProcess(m),T=userModel.findOne({userId:m.username},{$push:{notifications:{title:M,description:_,isAnnouncement:!1,voxId:O,date:Date.now(),url:D}}},{new:!0},(e,a)=>{});await w.save().then(e=>{a.send(e)})}}}),app.get("/getComments/:id",async(e,a)=>{var o=await commentModel.find({voxId:e.params.id,isArchived:{$nin:!0}}).sort({date:"desc"});a.send(o)}),app.post("/postReportComment",async(e,a)=>{var o=[];if(e.body.user.userData&&36==e.body.user.userData.userId.length){var n=await userModel.findOne({userId:e.body.user.userData.userId});n.commentDelay>Date.now()&&o.push("Tenes que esperar "+Math.floor((n.commentDelay-Date.now())/1e3)+" segundos para reportar")}else o.push("Usuario invalido");if(o.length>0){var r={errors:o};a.send(r)}else{let t=new reportModel({title:'Reportaron un comentario en el vox: "'+e.body.vox.title.substring(0,30)+'"',description:e.body.comment.commentText.substring(0,50),voxId:e.body.vox.filename,url:urlProcess(e.body.vox),commentId:e.body.comment.commentId});var s=userModel.findOneAndUpdate({userId:e.body.user.userData.userId},{commentDelay:new Date(Date.now()+15e3)},{new:!0},(e,a)=>{});await t.save().then(e=>{a.send(e)})}}),app.post("/postReportVox",async(e,a)=>{var o=[];if(e.body.user.userData&&36==e.body.user.userData.userId.length){var n=await userModel.findOne({userId:e.body.user.userData.userId});n.commentDelay>Date.now()&&o.push("Tenes que esperar "+Math.floor((n.commentDelay-Date.now())/1e3)+" segundos para reportar")}else o.push("Usuario invalido");if(o.length>0){var r={errors:o};a.send(r)}else{let t=new reportModel({title:'Reportaron el siguiente vox: "'+e.body.vox.title.substring(0,30)+'"',description:e.body.vox.description.substring(0,50),voxId:e.body.vox.filename,url:urlProcess(e.body.vox),commentId:" "});var s=userModel.findOneAndUpdate({userId:e.body.user.userData.userId},{commentDelay:new Date(Date.now()+15e3)},{new:!0},(e,a)=>{});await t.save().then(e=>{a.send(e)})}}),app.get("/getReports/:id",async(e,a)=>{var o=await reportModel.find().sort({date:"desc"});a.send(o)}),app.post("/removeReport",async(e,a)=>{var o=await reportModel.deleteMany({voxId:e.body.voxid}).catch(e=>{a.send(e)});a.send(o)}),app.post("/adminTool",async(e,a)=>{if(errors=[],(!e.body.data.reason||e.body.data.reason.length>7||1>e.body.data.reason.length)&&errors.push("Razon invalida"),(!e.body.data.description||e.body.data.description.length>300)&&errors.push("Descripcion invalida, podes poner un maximo de 300 caracteres"),e.body.data.userId&&36==e.body.data.userId.length||errors.push("Usuario invalido"),(!e.body.data.time||0>e.body.data.time||e.body.data.time>1e7)&&errors.push("Tiempo invalido, se aceptan un maximo de 10 millones de minutos"),e.body.user&&e.body.user.userData&&36==e.body.user.userData.userId.length){var o=await userModel.findOne({userId:e.body.user.userData.userId});o.rank&&("admin"===o.rank||"mod"===o.rank)?"nafa"!==o.modName&&7==e.body.data.reason&&errors.push("No sos nafa"):errors.push("Rango invalido")}else errors.push("Usuario invalido");if(errors.length>0){var n={errors:errors};a.send(n)}else if(!0==e.body.data.isComment){var r=await commentModel.findOneAndUpdate({filename:e.body.data.reportId},{isArchived:!0}).catch(e=>{});if("ban"===e.body.type){var t=await commentModel.findOne({filename:e.body.data.reportId}).catch(e=>{}),s=e.body.data.time;(2==e.body.data.reason||1==e.body.data.reason)&&s>1e4?s=1e4:(3==e.body.data.reason||4==e.body.data.reason||5==e.body.data.reason)&&s>5e4&&(s=5e4);let d=new blacklistModel({title:"Fuiste baneado por el mod: "+o.modName,description:e.body.data.description,ip:t.metadata[0].ip,macaddres:t.metadata[0].macaddres,dateEnd:new Date(Date.now()+6e4*s)});await d.save().then(e=>{a.send(e)})}else a.send(r)}else if(!1==e.body.data.isComment){var i=await voxModel.findOneAndUpdate({filename:e.body.data.reportId},{isArchived:!0}).catch(e=>{});if("ban"===e.body.type){var l=await voxModel.findOne({filename:e.body.data.reportId}).catch(e=>{}),s=e.body.data.time;(2==e.body.data.reason||1==e.body.data.reason)&&s>1e4?s=1e4:(3==e.body.data.reason||4==e.body.data.reason||5==e.body.data.reason)&&s>5e4&&(s=5e4);let c=new blacklistModel({title:"Fuiste baneado por el mod: "+o.modName,description:e.body.data.description,ip:l.metadata[0].ip,macaddres:l.metadata[0].macaddres,dateEnd:new Date(Date.now()+6e4*s)});await c.save().then(e=>{a.send(e)})}else a.send(i)}}),app.post("/janitorTools",async(e,a)=>{var o=[];if((!e.body.category||e.body.category>39||e.body.category<1)&&o.push("Categoria invalida"),e.body.user&&e.body.user.userData&&36==e.body.user.userData.userId.length){var n=await userModel.findOne({userId:e.body.user.userData.userId});n.rank&&("admin"===n.rank||"mod"===n.rank||"janitor"===n.rank)||o.push("Rango invalido")}else o.push("Usuario invalido");if(o.length>0){var r={errors:o};a.send(r)}else vox=await voxModel.findOneAndUpdate({filename:e.body.vox.filename},{category:e.body.category}),a.send(vox)});
